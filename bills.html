<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACS Calculator - Bills / Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Home Screen + Favicon (GitHub Pages repo path) -->
  <link rel="icon" href="/ACS_Calculator/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="/ACS_Calculator/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ACS_Calculator/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ACS_Calculator/apple-touch-icon.png">
  <link rel="manifest" href="/ACS_Calculator/manifest.json">
  <meta name="theme-color" content="#1f2937">

  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="bills.css">
</head>
<body>
<div class="wrapper">
  <h1>Bills / Payments</h1>

  <div class="top-actions">
    <button class="secondary" onclick="window.location.href='index.html'">← Report Card</button>
    <button class="secondary" onclick="window.location.href='daily-entry.html'">Daily entries</button>
    <button class="secondary" onclick="window.location.href='customers.html'">Change customer</button>
    <button class="danger" id="clearBillsBtn">Clear all bills</button>
    <button id="logoutBtn" onclick="acsLogout()" class="secondary">Logout</button>
  </div>

  <div class="list-card">
    <h2>All bills (latest first)</h2>
    <div id="billsList" class="muted">Loading…</div>
  </div>
</div>

<!-- ✅ Session tools (same as your project) -->
<script type="module" src="auth-guard.js"></script>
<script type="module" src="session.js"></script>
<script type="module" src="session-lock.js"></script>
<script type="module" src="session-heartbeat.js"></script>
<script type="module" src="logout.js"></script>

<!-- ✅ CLOUD Bills Logic -->
<script type="module">
  import { auth } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { listBills, addPayment, clearBills } from "./db-bills.js";

  const ACTIVE_KEY = "acsActiveCustomerId";

  const billsList = document.getElementById("billsList");
  const clearBillsBtn = document.getElementById("clearBillsBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function getActiveCustomerId(){
    try { return localStorage.getItem(ACTIVE_KEY) || ""; } catch { return ""; }
  }

  function statusFromAmounts(total, paid){
    const t = Number(total || 0);
    const p = Number(paid || 0);
    if (t <= 0) return "pending";
    if (p <= 0) return "pending";
    if (p < t) return "loading";
    return "success";
  }

  function formatDateShort(dStr) {
    // YYYY-MM-DD -> DD-MM-YYYY (same as your old)
    return String(dStr || "").split("-").reverse().join("-");
  }

  async function refreshBills(){
    const customerId = getActiveCustomerId();
    if (!customerId) {
      window.location.href = "customers.html";
      return;
    }

    billsList.textContent = "Loading…";
    billsList.classList.add("muted");

    let bills = [];
    try {
      bills = await listBills(customerId, 200);
    } catch (e) {
      console.error(e);
      billsList.textContent = "Failed to load bills. Please refresh.";
      return;
    }

    if (!Array.isArray(bills) || bills.length === 0) {
      billsList.textContent = "No bills yet. Generate a report from the main page.";
      billsList.classList.add("muted");
      return;
    }

    billsList.innerHTML = "";
    billsList.classList.remove("muted");

    // newest first already, but keep your old style safety sort:
    bills.sort((a, b) => {
      const ta = a.createdAt ? Date.parse(a.createdAt) : 0;
      const tb = b.createdAt ? Date.parse(b.createdAt) : 0;
      return tb - ta;
    });

    bills.forEach((bill, index) => {
      const total = Number(bill.total || 0);
      const paid  = Number(bill.paid || 0);
      const remaining = Math.max(total - paid, 0);
      const status = statusFromAmounts(total, paid);

      const item = document.createElement("div");
      item.className = "bill-item bill-" + status;

      const header = document.createElement("div");
      header.className = "bill-header";

      const range = document.createElement("div");
      range.className = "bill-range";
      range.textContent = `${formatDateShort(bill.from)} to ${formatDateShort(bill.to)}`;

      const idSpan = document.createElement("div");
      idSpan.className = "bill-id";
      idSpan.textContent = `Bill #${bills.length - index}`;

      header.appendChild(range);
      header.appendChild(idSpan);

      const meta = document.createElement("div");
      meta.className = "bill-meta";

      const pill = document.createElement("span");
      pill.className = "pill status-" + status;
      pill.textContent =
        status === "pending" ? "Pending (editable entries)"
        : status === "loading" ? "Payment started (locked)"
        : "Paid (locked)";

      const amounts = document.createElement("div");
      amounts.className = "bill-amounts";
      amounts.textContent =
        `Total: ₹${total.toFixed(0)} | Paid: ₹${paid.toFixed(0)} | Remaining: ₹${remaining.toFixed(0)}`;

      const payBtn = document.createElement("button");
      payBtn.className = "pay-btn";
      payBtn.textContent = "Add payment";

      payBtn.addEventListener("click", async () => {
        const input = prompt("Payment received now (₹):", "");
        if (input === null) return;

        const amt = parseFloat(input);
        if (isNaN(amt) || amt <= 0) {
          alert("Please enter a valid amount.");
          return;
        }

        try {
          // Cloud: increment paid
          await addPayment(customerId, bill.id || bill.billId, amt);
          await refreshBills();
        } catch (e) {
          console.error(e);
          alert("Payment failed. Please try again.");
        }
      });

      meta.appendChild(pill);
      meta.appendChild(amounts);
      meta.appendChild(payBtn);

      item.appendChild(header);
      item.appendChild(meta);
      billsList.appendChild(item);
    });
  }

  clearBillsBtn.addEventListener("click", async () => {
    const customerId = getActiveCustomerId();
    if (!customerId) return window.location.href = "customers.html";

    if (!confirm("Clear ALL bills for this customer?")) return;

    try {
      await clearBills(customerId);
      await refreshBills();
    } catch (e) {
      console.error(e);
      alert("Failed to clear bills.");
    }
  });

  // ✅ Logout safety (in case acsLogout not available)
  logoutBtn.addEventListener("click", async () => {
    if (window.acsLogout) return; // logout.js will handle
    try { await signOut(auth); } catch {}
    window.location.href = "login.html";
  });

  // ✅ Load bills only after auth is ready
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    await refreshBills();
  });
</script>
</body>
</html>
