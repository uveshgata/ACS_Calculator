<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACS Calculator - Customers</title>

  <!-- ‚úÖ Favicons / PWA -->
  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <link rel="stylesheet" href="base.css">

  <style>
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eef2ff, #e5e7eb);
      display:flex; justify-content:center;
    }
    .wrapper{ width:100%; max-width:640px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px;
    }
    h1{
      margin:0;
      font-size:22px;
      font-weight:1000;
      color:#111827;
      letter-spacing:.01em;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
      font-weight:900;
      color:#111827;
      font-size:13px;
      white-space:nowrap;
    }

    .actions-row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .btn{
      border:none; border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color:#fff;
      box-shadow: 0 10px 22px rgba(88,80,236,0.35);
    }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn.danger{ background:#fee2e2; color:#b91c1c; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      margin-bottom:12px;
    }

    .search-row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .search{
      flex:1 1 240px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
      transition:.15s;
      background:#fff;
      font-weight:700;
    }
    .search:focus{
      border-color:#6366f1;
      box-shadow:0 0 0 3px rgba(99,102,241,.20);
    }

    .msg{
      margin-top:10px;
      font-size:13px;
      font-weight:1000;
      text-align:center;
      word-break:break-word;
    }
    .msg.ok{ color:#047857; }
    .msg.err{ color:#b91c1c; }

    .list{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .item{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .item.active{
      border-color:#4f46e5;
      box-shadow: 0 8px 20px rgba(79,70,229,0.16);
      background: linear-gradient(180deg, #f7f7ff, #fbfbff);
    }
    .left{ min-width:0; }
    .name{
      font-size:15px;
      font-weight:1000;
      color:#111827;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:360px;
    }
    .sub{
      margin-top:2px;
      font-size:12px;
      color:#6b7280;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:360px;
    }
    .right{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .mini{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
    }
    .mini.danger{ background:#fee2e2; color:#b91c1c; }

    .empty{
      margin-top:12px;
      text-align:center;
      color:#6b7280;
      font-weight:900;
      font-size:13px;
    }

    /* ===== Modal ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 14px 10px;
      background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(124,58,237,.10));
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modal-title{
      font-size:15px;
      font-weight:1000;
      color:#111827;
      margin:0;
    }
    .modal-close{
      border:none;
      border-radius:10px;
      padding:8px 10px;
      background:#e5e7eb;
      font-weight:1000;
      cursor:pointer;
    }
    .modal-body{
      padding:14px;
    }
    .field{ margin-bottom:10px; }
    label{
      display:block;
      font-size:13px;
      font-weight:900;
      color:#374151;
      margin-bottom:6px;
    }
    input.modal-in{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
      transition:.15s;
      background:#fff;
      font-weight:700;
    }
    input.modal-in:focus{
      border-color:#6366f1;
      box-shadow:0 0 0 3px rgba(99,102,241,.20);
    }
    .modal-foot{
      padding:12px 14px 14px;
      border-top:1px solid #e5e7eb;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .note{
      font-size:12px;
      color:#6b7280;
      font-weight:700;
      margin-top:6px;
      line-height:1.4;
    }
  </style>
</head>

<body>
<div class="wrapper">

  <div class="topbar">
    <h1>Customers</h1>
    <div class="pill" id="activePill">Active: ‚Äî</div>
  </div>

  <div class="actions-row">
    <button class="btn secondary" onclick="window.location.href='index.html'">‚Üê Back to Report</button>
    <button class="btn primary" id="openAddBtn">+ Add Customer</button>
    <button class="btn secondary" id="refreshBtn">Refresh</button>
    <button class="btn danger" id="logoutBtn">Logout</button>
  </div>

  <div class="card">
    <div class="search-row">
      <input id="searchInput" class="search" placeholder="Search customer name / phone‚Ä¶" />
    </div>

    <div id="msg" class="msg"></div>

    <div id="list" class="list"></div>
    <div id="empty" class="empty">Loading‚Ä¶</div>
  </div>

</div>

<!-- ===== Modal Add/Edit Customer ===== -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Add Customer</div>
      <button class="modal-close" id="closeModalBtn">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="field">
        <label>Customer Name</label>
        <input id="custName" class="modal-in" placeholder="e.g. Rahul Sharma" />
      </div>

      <div class="field">
        <label>Customer Phone</label>
        <input id="custPhone" class="modal-in" placeholder="e.g. 9876543210" inputmode="numeric" />
        <div class="note">Same name + same phone cannot be saved twice.</div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn primary" id="saveBtn" style="flex:1 1 180px;">Save</button>
      <button class="btn secondary" id="cancelBtn" style="flex:1 1 180px;">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Protected page scripts -->
<script type="module" src="auth-guard.js"></script>
<script type="module" src="session.js"></script>
<script type="module" src="session-lock.js"></script>
<script type="module" src="session-heartbeat.js"></script>
<script type="module" src="logout.js"></script>

<script type="module">
  import { onAuthStateChanged, getAuth } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { listCustomers, upsertCustomer, removeCustomer } from "./db-customers.js";

  const auth = getAuth();

  const ACTIVE_KEY = "acsActiveCustomerId";

  const activePill = document.getElementById("activePill");
  const msgEl = document.getElementById("msg");
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  const refreshBtn = document.getElementById("refreshBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const searchInput = document.getElementById("searchInput");

  // Modal
  const modalBackdrop = document.getElementById("modalBackdrop");
  const openAddBtn = document.getElementById("openAddBtn");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");
  const modalTitle = document.getElementById("modalTitle");
  const custName = document.getElementById("custName");
  const custPhone = document.getElementById("custPhone");

  let allCustomers = [];
  let editingCustomerId = null; // null => add mode

  function showMsg(text, type){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (type || "");
  }

  function normalizeName(s){
    return String(s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }
  function normalizePhone(s){
    return String(s || "").replace(/\D/g, "");
  }
  function safeIdPart(s){
    return String(s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^a-z0-9_]/g, "");
  }
  function genCustomerId(name, phoneDigits){
    return `CUST_${safeIdPart(name) || "customer"}_${phoneDigits || "no"}_${Date.now().toString(36)}`;
  }

  function getActiveId(){
    try { return localStorage.getItem(ACTIVE_KEY) || ""; } catch { return ""; }
  }
  function setActiveId(id){
    try { localStorage.setItem(ACTIVE_KEY, id); } catch {}
  }

  function openModalAdd(){
    editingCustomerId = null;
    modalTitle.textContent = "Add Customer";
    custName.value = "";
    custPhone.value = "";
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden", "false");
    custName.focus();
  }

  function openModalEdit(customer){
    editingCustomerId = customer.customerId;
    modalTitle.textContent = "Edit Customer";
    custName.value = customer.displayName || "";
    custPhone.value = customer.phone || "";
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden", "false");
    custName.focus();
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden", "true");
    editingCustomerId = null;
    custName.value = "";
    custPhone.value = "";
  }

  openAddBtn.addEventListener("click", openModalAdd);
  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  logoutBtn.addEventListener("click", () => window.acsLogout && window.acsLogout());

  function updateActivePill(){
    const activeId = getActiveId();
    const active = allCustomers.find(c => c.customerId === activeId);
    activePill.textContent = "Active: " + (active ? (active.displayName || "Unnamed") : "‚Äî");
  }

  function sortCustomers(list){
    return [...list].sort((a,b) => {
      const av = a.lastVisitedMs || 0;
      const bv = b.lastVisitedMs || 0;
      if (bv !== av) return bv - av;

      const ac = a.createdAtMs || 0;
      const bc = b.createdAtMs || 0;
      if (bc !== ac) return bc - ac;

      const an = (a.normalizedName || "").toLowerCase();
      const bn = (b.normalizedName || "").toLowerCase();
      return an.localeCompare(bn);
    });
  }

  function render(list){
    listEl.innerHTML = "";
    const activeId = getActiveId();

    if (!list || list.length === 0) {
      emptyEl.textContent = "No customers yet. Tap ‚ÄúAdd Customer‚Äù.";
      updateActivePill();
      return;
    }
    emptyEl.textContent = "";

    list.forEach(c => {
      const item = document.createElement("div");
      item.className = "item" + (c.customerId === activeId ? " active" : "");

      const left = document.createElement("div");
      left.className = "left";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = c.displayName || "Unnamed customer";

      const sub = document.createElement("div");
      sub.className = "sub";
      sub.textContent = c.phone ? `üìû ${c.phone}` : "No phone";

      left.appendChild(name);
      left.appendChild(sub);

      const right = document.createElement("div");
      right.className = "right";

      const selectBtn = document.createElement("button");
      selectBtn.className = "mini";
      selectBtn.textContent = "Select";
      selectBtn.addEventListener("click", async () => {
        setActiveId(c.customerId);
        try {
          await upsertCustomer({ customerId: c.customerId, lastVisitedMs: Date.now() });
        } catch {}
        window.location.href = "index.html";
      });

      const editBtn = document.createElement("button");
      editBtn.className = "mini";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => openModalEdit(c));

      const delBtn = document.createElement("button");
      delBtn.className = "mini danger";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", async () => {
        const ok = confirm(`Delete customer "${c.displayName}"?\n\n(Only deletes profile. Entries will be handled later.)`);
        if (!ok) return;

        await removeCustomer(c.customerId);

        if (getActiveId() === c.customerId) {
          try { localStorage.removeItem(ACTIVE_KEY); } catch {}
        }
        await load();
      });

      right.appendChild(selectBtn);
      right.appendChild(editBtn);
      right.appendChild(delBtn);

      item.appendChild(left);
      item.appendChild(right);
      listEl.appendChild(item);
    });

    updateActivePill();
  }

  function applySearch(){
    const q = (searchInput.value || "").trim().toLowerCase();
    if (!q) return render(sortCustomers(allCustomers));

    const filtered = allCustomers.filter(c => {
      const name = (c.displayName || "").toLowerCase();
      const phone = String(c.phone || "");
      return name.includes(q) || phone.includes(q);
    });

    render(sortCustomers(filtered));
  }
  searchInput.addEventListener("input", applySearch);

  async function load(){
    try {
      emptyEl.textContent = "Loading‚Ä¶";
      showMsg("", "");
      const customers = await listCustomers();
      allCustomers = Array.isArray(customers) ? customers : [];
      applySearch(); // renders sorted
    } catch (e) {
      console.error(e);
      emptyEl.textContent = "Failed to load customers. Check login / Firestore rules.";
      showMsg("‚ùå Could not load customers from cloud.", "err");
    }
  }
  refreshBtn.addEventListener("click", load);

  saveBtn.addEventListener("click", async () => {
    const name = custName.value.trim();
    const phoneDigits = normalizePhone(custPhone.value);

    if (!name) return showMsg("Enter customer name.", "err");

    saveBtn.disabled = true;
    showMsg("Saving‚Ä¶", "");

    try {
      const current = await listCustomers();
      const nName = normalizeName(name);

      // ‚úÖ duplicate check (ignore self when editing)
      const dup = (current || []).find(c => {
        if (editingCustomerId && c.customerId === editingCustomerId) return false;
        const cn = (c.normalizedName || normalizeName(c.displayName || ""));
        const cp = normalizePhone(c.phone || "");
        return cn === nName && cp === phoneDigits;
      });

      if (dup) {
        showMsg("‚ö†Ô∏è Duplicate found (same name + phone).", "err");
        saveBtn.disabled = false;
        return;
      }

      if (!editingCustomerId) {
        // ADD
        const customerId = genCustomerId(name, phoneDigits);
        await upsertCustomer({
          customerId,
          displayName: name,
          normalizedName: nName,
          phone: phoneDigits,
          createdAtMs: Date.now(),
          lastVisitedMs: Date.now()
        });
        closeModal();
        showMsg("‚úÖ Customer saved.", "ok");
        await load();
        return;
      }

      // EDIT
      await upsertCustomer({
        customerId: editingCustomerId,
        displayName: name,
        normalizedName: nName,
        phone: phoneDigits
      });

      closeModal();
      showMsg("‚úÖ Customer updated.", "ok");
      await load();
    } catch (e) {
      console.error(e);
      showMsg("‚ùå Save failed.", "err");
    } finally {
      saveBtn.disabled = false;
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    await load();
  });
</script>
</body>
</html>
