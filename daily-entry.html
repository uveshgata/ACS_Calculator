<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACS Calculator - Daily Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Home Screen + Favicon (GitHub Pages repo path) -->
<link rel="icon" href="/ACS_Calculator/favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="/ACS_Calculator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/ACS_Calculator/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/ACS_Calculator/apple-touch-icon.png">
<link rel="manifest" href="/ACS_Calculator/manifest.json">
<meta name="theme-color" content="#1f2937">

  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="daily-entry.css">
</head>
<body>
<div class="wrapper">
  <h1>Daily Entry</h1>

  <div class="top-actions">
    <button class="secondary" onclick="window.location.href='index.html'">← Report Card</button>
    <button class="secondary" onclick="window.location.href='bills.html'">Bills / Payments</button>
    <button class="secondary" onclick="window.location.href='customers.html'">Change customer</button>
    <button class="danger" id="clearAllBtn">Clear all entries</button>
    <button onclick="acsLogout()" class="secondary">Logout</button>
  </div>

  <div class="card">
    <div id="activeCustomerLine" class="note" style="margin-bottom:10px;"></div>

    <label for="date">Date</label>
    <input type="date" id="date" />

    <label for="kg">Quantity (kg)</label>
    <input type="number" id="kg" placeholder="e.g. 10" step="1" min="0" />

    <label for="rate">Rate (₹ per kg)</label>
    <input type="number" id="rate" placeholder="e.g. 230" step="10" min="0" />

    <button class="primary" id="saveBtn">Save entry</button>
    <div class="status-text" id="statusMsg"></div>

    <div class="note">
      Customer-specific data is stored in this browser.
    </div>
  </div>

  <div class="list-card">
    <h2>Saved entries (latest 15)</h2>
    <div id="entriesList" class="muted">No entries yet.</div>
  </div>
</div>

<script>
  const CUSTOMERS_KEY = "acsCustomers";
  const ACTIVE_KEY    = "acsActiveCustomerId";

  function getActiveCustomerId() {
    return localStorage.getItem(ACTIVE_KEY);
  }
  function getCustomers() {
    try { return JSON.parse(localStorage.getItem(CUSTOMERS_KEY)) || []; } catch { return []; }
  }
  function getActiveCustomer() {
    const id = getActiveCustomerId();
    return getCustomers().find(c => c.customerId === id) || null;
  }

  const customerId = getActiveCustomerId();
  if (!customerId) window.location.href = "customers.html";

  const ENTRIES_KEY = `acsEntries:${customerId}`;
  const BILLS_KEY   = `acsBills:${customerId}`;

  const dateInput   = document.getElementById("date");
  const kgInput     = document.getElementById("kg");
  const rateInput   = document.getElementById("rate");
  const saveBtn     = document.getElementById("saveBtn");
  const statusMsg   = document.getElementById("statusMsg");
  const entriesList = document.getElementById("entriesList");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const activeCustomerLine = document.getElementById("activeCustomerLine");

  const activeCustomer = getActiveCustomer();
  activeCustomerLine.textContent = activeCustomer
    ? `Active customer: ${activeCustomer.displayName}${activeCustomer.phone ? " • " + activeCustomer.phone : ""}`
    : `Active customer ID: ${customerId}`;

  function todayIso() {
    const t = new Date();
    return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
  }

  function getStoredEntries() {
    try { return JSON.parse(localStorage.getItem(ENTRIES_KEY)) || {}; } catch { return {}; }
  }
  function setStoredEntries(obj) {
    localStorage.setItem(ENTRIES_KEY, JSON.stringify(obj));
  }

  function getBills() {
    try { return JSON.parse(localStorage.getItem(BILLS_KEY)) || []; } catch { return []; }
  }
  function setBills(bills) {
    localStorage.setItem(BILLS_KEY, JSON.stringify(bills));
  }

  function statusFromAmounts(bill) {
    const total = bill.total || 0;
    const paid  = bill.paid  || 0;
    if (total <= 0) return "pending";
    if (paid <= 0) return "pending";
    if (paid < total) return "loading";
    return "success";
  }

  function billStageForDate(dateIso) {
    const bills = getBills();
    const order = { pending: 1, loading: 2, success: 3 };
    let best = null;

    bills.forEach(b => {
      if (!b.from || !b.to) return;
      if (b.from <= dateIso && dateIso <= b.to) {
        const s = statusFromAmounts(b);
        if (!best || order[s] > order[best]) best = s;
      }
    });

    return best; // null | pending | loading | success
  }

  // lock only when payment started (loading/success)
  function isLockedDate(dateIso) {
    const stage = billStageForDate(dateIso);
    return stage === "loading" || stage === "success";
  }

  function recomputeBillsForDate(dateIso) {
    const entries = getStoredEntries();
    const bills = getBills();
    let changed = false;

    bills.forEach(bill => {
      if (!bill.from || !bill.to) return;
      if (!(bill.from <= dateIso && dateIso <= bill.to)) return;

      let sum = 0;
      for (let d = new Date(bill.from); d <= new Date(bill.to); d.setDate(d.getDate()+1)) {
        const iso = d.toISOString().slice(0,10);
        const e = entries[iso];
        if (e) {
          const kg = parseFloat(e.kg);
          const rate = parseFloat(e.rate);
          if (!isNaN(kg) && !isNaN(rate)) sum += kg * rate;
        }
      }

      const stage = statusFromAmounts(bill);
      // Only update totals if still pending (payment not initialized)
      if (stage === "pending") {
        if ((bill.total || 0) !== sum) {
          bill.total = sum;
          bill.status = statusFromAmounts(bill);
          changed = true;
        }
      }
    });

    if (changed) setBills(bills);
  }

  function applyDateLimits() {
    dateInput.max = todayIso();
  }
  function setTodayDate() {
    dateInput.value = todayIso();
  }
  function formatDateForGujaratiPrompt(dateIso) {
    try {
      return new Date(dateIso).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
    } catch { return dateIso; }
  }

  function refreshList() {
    const entries = getStoredEntries();
    let keys = Object.keys(entries).sort();
    if (keys.length === 0) {
      entriesList.textContent = "No entries yet.";
      entriesList.classList.add("muted");
      return;
    }
    if (keys.length > 15) keys = keys.slice(-15);
    keys = keys.reverse();

    entriesList.innerHTML = "";
    entriesList.classList.remove("muted");

    keys.forEach(dateIso => {
      const e = entries[dateIso];
      const total = (e.kg || 0) * (e.rate || 0);
      const stage = billStageForDate(dateIso);
      const locked = isLockedDate(dateIso);

      const item = document.createElement("div");
      item.className = "entry-item";
      if (stage === "pending") item.classList.add("entry-pending");
      if (stage === "loading") item.classList.add("entry-loading");
      if (stage === "success") item.classList.add("entry-success");

      const left = document.createElement("div");
      left.className = "entry-left";

      const dateSpan = document.createElement("span");
      dateSpan.className = "entry-date";
      dateSpan.textContent = dateIso;
      left.appendChild(dateSpan);

      if (stage) {
        const pill = document.createElement("span");
        pill.className = "entry-status-pill " +
          (stage === "pending" ? "pill-pending" :
           stage === "loading" ? "pill-loading" : "pill-success");
        pill.textContent =
          stage === "pending" ? "Bill pending (editable)" :
          stage === "loading" ? "Payment started (locked)" :
          "Bill paid (locked)";
        left.appendChild(pill);
      }

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.alignItems = "center";
      right.style.gap = "10px";

      const amountText = document.createElement("span");
      amountText.textContent = `${e.kg} kg × ₹${e.rate} = ₹${total.toFixed(0)}`;

      const actions = document.createElement("div");
      actions.className = "entry-actions";

      const editBtn = document.createElement("button");
      editBtn.className = "small-btn edit";
      editBtn.textContent = "Edit";
      editBtn.disabled = locked;
      editBtn.addEventListener("click", () => {
        if (locked) return;
        dateInput.value = dateIso;
        kgInput.value = e.kg;
        rateInput.value = e.rate;
        statusMsg.textContent = `Editing: ${dateIso} (update and Save)`;
        statusMsg.style.color = "#0369a1";
        window.scrollTo({ top: 0, behavior: "smooth" });
        kgInput.focus();
      });

      const delBtn = document.createElement("button");
      delBtn.className = "small-btn delete";
      delBtn.textContent = "Delete";
      delBtn.disabled = locked;
      delBtn.addEventListener("click", () => {
        if (locked) {
          alert("આ તારીખની એન્ટ્રી લોક છે કારણ કે પેમેન્ટ શરૂ થઈ ગયું છે.");
          return;
        }
        if (!confirm(`Delete entry for ${dateIso}?`)) return;

        const all = getStoredEntries();
        delete all[dateIso];
        setStoredEntries(all);

        recomputeBillsForDate(dateIso);

        refreshList();
        statusMsg.textContent = `Deleted: ${dateIso}`;
        statusMsg.style.color = "#b91c1c";

        setTodayDate();
        kgInput.value = "";
        rateInput.value = "";
      });

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      right.appendChild(amountText);
      right.appendChild(actions);

      item.appendChild(left);
      item.appendChild(right);
      entriesList.appendChild(item);
    });
  }

  saveBtn.addEventListener("click", () => {
    const dateVal = dateInput.value;
    const kg = parseFloat(kgInput.value);
    const rate = parseFloat(rateInput.value);

    if (!dateVal || isNaN(kg) || isNaN(rate)) {
      statusMsg.textContent = "Please enter date, kg and rate.";
      statusMsg.style.color = "#b91c1c";
      return;
    }

    // Future block
    const t = todayIso();
    if (dateVal > t) {
      statusMsg.textContent = "Future date entry is not allowed.";
      statusMsg.style.color = "#b91c1c";
      return;
    }

    // Lock only if payment started
    if (isLockedDate(dateVal)) {
      statusMsg.textContent = "Locked: payment already started for this bill.";
      statusMsg.style.color = "#b91c1c";
      return;
    }

    const entries = getStoredEntries();
    const exists = !!entries[dateVal];

    if (exists) {
      const pretty = formatDateForGujaratiPrompt(dateVal);
      const ok = confirm(
        `તારીખ ${pretty} ની એન્ટ્રી દાખલ થયેલ છે.\nશું તમે જૂની એન્ટ્રીના બદલે નવી એન્ટ્રી સેવ કરવા માંગો છો?`
      );
      if (!ok) {
        statusMsg.textContent = "Overwrite cancelled.";
        statusMsg.style.color = "#92400e";
        return;
      }
    }

    entries[dateVal] = { kg, rate };
    setStoredEntries(entries);

    recomputeBillsForDate(dateVal);

    statusMsg.textContent = `Saved: ${dateVal} → ${kg} kg × ₹${rate}`;
    statusMsg.style.color = "#047857";
    refreshList();

    kgInput.value = "";
    rateInput.value = "";
    setTodayDate();
    kgInput.focus();
  });

  clearAllBtn.addEventListener("click", () => {
    if (confirm("Clear all saved entries for this customer?")) {
      localStorage.removeItem(ENTRIES_KEY);
      refreshList();
      statusMsg.textContent = "All entries cleared.";
      statusMsg.style.color = "#b91c1c";
      setTodayDate();
      kgInput.value = "";
      rateInput.value = "";
    }
  });

  applyDateLimits();
  setTodayDate();
  refreshList();
</script>
  <script type="module" src="auth-guard.js"></script>
  <script type="module" src="session.js"></script>
  <script type="module" src="logout.js"></script>
</body>
</html>
