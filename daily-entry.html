<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACS Calculator - Daily Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="daily-entry.css">
</head>
<body>

<div class="wrapper">
  <h1>Daily Entry</h1>

  <div class="top-actions">
    <button class="secondary" onclick="window.location.href='index.html'">â† Report Card</button>
    <button class="secondary" onclick="window.location.href='bills.html'">Bills / Payments</button>
    <button class="secondary" id="exportBtn">Export data (JSON)</button>
    <button class="secondary" id="importBtn">Import data (JSON)</button>
    <button class="danger" id="clearAllBtn">Clear all entries</button>
    <input type="file" id="importFile" accept="application/json" />
  </div>

  <div class="card">
    <label>Date</label>
    <input type="date" id="date" />

    <label>Quantity (kg)</label>
    <input type="number" id="kg" step="0.01" min="0" />

    <label>Rate (â‚¹ per kg)</label>
    <input type="number" id="rate" step="0.01" min="0" />

    <button class="primary" id="saveBtn">Save entry</button>
    <div class="status-text" id="statusMsg"></div>

    <div class="note">
      Entries are stored only in this browser (local).
      Use Export / Import if you switch device.
    </div>
  </div>

  <div class="list-card">
    <h2>Saved entries (latest 15)</h2>
    <div id="entriesList" class="muted">No entries yet.</div>
  </div>
</div>

<script>
const ENTRIES_KEY = "acsEntries";
const BILLS_KEY = "acsBills";

const dateInput = document.getElementById("date");
const kgInput = document.getElementById("kg");
const rateInput = document.getElementById("rate");
const saveBtn = document.getElementById("saveBtn");
const statusMsg = document.getElementById("statusMsg");
const entriesList = document.getElementById("entriesList");
const clearAllBtn = document.getElementById("clearAllBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

/* ================= HELPERS ================= */

function getStoredEntries() {
  try {
    return JSON.parse(localStorage.getItem(ENTRIES_KEY)) || {};
  } catch {
    return {};
  }
}

function setStoredEntries(obj) {
  localStorage.setItem(ENTRIES_KEY, JSON.stringify(obj));
}

function setTodayDate() {
  const t = new Date();
  dateInput.value =
    `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
}

/* ================= SAVE ENTRY ================= */

saveBtn.addEventListener("click", () => {
  const dateVal = dateInput.value;
  const kg = parseFloat(kgInput.value);
  const rate = parseFloat(rateInput.value);

  if (!dateVal || isNaN(kg) || isNaN(rate)) {
    statusMsg.textContent = "Please enter date, kg and rate.";
    statusMsg.style.color = "#b91c1c";
    return;
  }

  const entries = getStoredEntries();

  // ğŸ”´ OVERWRITE CHECK
  if (entries[dateVal]) {
    const dateText = new Date(dateVal).toLocaleDateString("en-GB", {
      day: "2-digit", month: "short", year: "numeric"
    });

    const confirmOverwrite = confirm(
      `àª¤àª¾àª°à«€àª– ${dateText} àª¨à«€ àªàª¨à«àªŸà«àª°à«€ àª¦àª¾àª–àª² àª¥àª¯à«‡àª² àª›à«‡.\nàª¶à«àª‚ àª¤àª®à«‡ àªœà«‚àª¨à«€ àªàª¨à«àªŸà«àª°à«€àª¨àª¾ àª¬àª¦àª²à«‡ àª¨àªµà«€ àªàª¨à«àªŸà«àª°à«€ àª¸à«‡àªµ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?`
    );

    if (!confirmOverwrite) {
      statusMsg.textContent = "Save cancelled.";
      statusMsg.style.color = "#92400e";
      return;
    }
  }

  // Save / overwrite
  entries[dateVal] = { kg, rate };
  setStoredEntries(entries);

  statusMsg.textContent = `Saved: ${dateVal} â†’ ${kg} kg Ã— â‚¹${rate}`;
  statusMsg.style.color = "#047857";

  refreshList();

  // ğŸ” RESET INPUTS AFTER SAVE
  kgInput.value = "";
  rateInput.value = "";
  setTodayDate();
  kgInput.focus();
});

/* ================= LIST ================= */

function statusFromAmounts(bill) {
  const total = bill.total || 0;
  const paid = bill.paid || 0;
  if (total <= 0) return "pending";
  if (paid <= 0) return "pending";
  if (paid < total) return "loading";
  return "success";
}

function getBills() {
  try {
    return JSON.parse(localStorage.getItem(BILLS_KEY)) || [];
  } catch {
    return [];
  }
}

function statusForDate(dateIso) {
  const bills = getBills();
  const order = { pending: 1, loading: 2, success: 3 };
  let best = null;

  bills.forEach(b => {
    if (b.from <= dateIso && dateIso <= b.to) {
      const s = statusFromAmounts(b);
      if (!best || order[s] > order[best]) best = s;
    }
  });

  return best;
}

function refreshList() {
  const entries = getStoredEntries();
  let keys = Object.keys(entries).sort();
  if (!keys.length) {
    entriesList.textContent = "No entries yet.";
    entriesList.classList.add("muted");
    return;
  }

  keys = keys.slice(-15).reverse();
  entriesList.innerHTML = "";
  entriesList.classList.remove("muted");

  keys.forEach(dateIso => {
    const e = entries[dateIso];
    const total = e.kg * e.rate;
    const status = statusForDate(dateIso);

    const item = document.createElement("div");
    item.className = `entry-item ${status ? "entry-"+status : ""}`;

    const left = document.createElement("div");
    left.className = "entry-left";

    left.innerHTML = `<span class="entry-date">${dateIso}</span>`;

    const right = document.createElement("span");
    right.textContent = `${e.kg} kg Ã— â‚¹${e.rate} = â‚¹${total.toFixed(0)}`;

    item.append(left, right);
    entriesList.appendChild(item);
  });
}

/* ================= INIT ================= */

setTodayDate();
refreshList();
</script>

</body>
</html>
