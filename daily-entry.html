<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACS Calculator - Daily Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Favicons / PWA -->
  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="daily-entry.css">

  <style>
    /* If daily-entry.css missing, page still looks OK */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eef2ff, #e5e7eb);
      display: flex;
      justify-content: center;
    }
    .wrapper { width: 100%; max-width: 520px; }

    h1 {
      text-align: center;
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 900;
      color: #111827;
    }

    .top-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      transition: .15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    button.primary {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      box-shadow: 0 6px 14px rgba(88,80,236,0.35);
    }
    button.secondary { background: #e5e7eb; color: #111827; }
    button.danger { background: #fee2e2; color: #b91c1c; }

    .card {
      background: #ffffff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      margin-bottom: 16px;
      border:1px solid #e5e7eb;
    }

    .active-customer-banner{
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .ac-left{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .ac-title{
      font-size:12px; color:#6b7280; font-weight:900; letter-spacing:.02em; text-transform:uppercase;
    }
    .ac-name{
      font-size:15px; font-weight:1000; color:#111827; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 320px;
    }
    .ac-sub{
      font-size:12px; color:#6b7280;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 320px;
    }
    .ac-btn{
      padding:8px 12px; border-radius:999px; border:none;
      background:#e5e7eb; color:#111827; font-weight:900; cursor:pointer; white-space:nowrap;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
      font-weight: 800;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      margin-bottom: 10px;
      outline: none;
      transition: .15s;
    }
    input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99,102,241,.22);
    }

    .status-text {
      font-size: 13px;
      margin-top: 8px;
      font-weight: 900;
      text-align:center;
    }

    .note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      line-height:1.4;
      text-align:center;
      font-weight:700;
    }

    .list-card {
      background: #ffffff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border:1px solid #e5e7eb;
    }
    .list-card h2 { margin: 0 0 8px; font-size: 15px; font-weight: 1000; }

    .entry-item {
      font-size: 13px;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-radius: 12px;
      margin-bottom: 6px;
      background: #f9fafb;
      border: 1px solid transparent;
    }
    .entry-item:last-child { border-bottom: none; }

    .entry-pending { background:#f9fafb; border-color:#e5e7eb; }
    .entry-loading { background:#fefce8; border-color:#facc15; }
    .entry-success { background:#ecfdf5; border-color:#16a34a; }

    .entry-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width:0;
    }
    .entry-date {
      font-weight: 1000;
      color: #111827;
    }
    .entry-status-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-block;
      font-weight: 900;
      width: fit-content;
    }
    .pill-pending { background:#e5e7eb; color:#374151; }
    .pill-loading { background:#fef3c7; color:#92400e; }
    .pill-success { background:#dcfce7; color:#166534; }

    .entry-right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini-btn{
      border:none;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
    }
    .mini-btn.danger{ background:#fee2e2; color:#b91c1c; }

    .muted { color: #6b7280; font-weight:800; }
  </style>
</head>

<body>
<div class="wrapper">
  <h1>Daily Entry</h1>

  <!-- ‚úÖ Clear customer display on page -->
  <div class="active-customer-banner">
    <div class="ac-left">
      <div class="ac-title">Active Customer</div>
      <div id="acName" class="ac-name">‚Äî</div>
      <div id="acSub" class="ac-sub">‚Äî</div>
    </div>
    <button class="ac-btn" onclick="window.location.href='customers.html'">Change</button>
  </div>

  <div class="top-actions">
    <button class="secondary" onclick="window.location.href='index.html'">‚Üê Report Card</button>
    <button class="secondary" onclick="window.location.href='bills.html'">Bills / Payments</button>
    <button class="danger" id="logoutBtn">Logout</button>
  </div>

  <div class="card">
    <label for="date">Date</label>
    <input type="date" id="date" />

    <label for="kg">Quantity (kg)</label>
    <input type="number" id="kg" placeholder="e.g. 10" step="0.01" min="0" />

    <label for="rate">Rate (‚Çπ per kg)</label>
    <input type="number" id="rate" placeholder="e.g. 230" step="0.01" min="0" />

    <button class="primary" id="saveBtn">Save entry</button>

    <div class="status-text" id="statusMsg"></div>
    <div class="note">
      Entries are now saved in Cloud (Firestore) for this customer.
    </div>
  </div>

  <div class="list-card">
    <h2>Saved entries (latest 15)</h2>
    <div id="entriesList" class="muted">Loading‚Ä¶</div>
  </div>
</div>

<!-- ‚úÖ Auth/session -->
<script type="module" src="auth-guard.js"></script>
<script type="module" src="session.js"></script>
<script type="module" src="session-lock.js"></script>
<script type="module" src="session-heartbeat.js"></script>
<script type="module" src="logout.js"></script>

<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { listCustomers } from "./db-customers.js";
  import { upsertEntry, getEntry, deleteEntry, listLatestEntries } from "./db-entries.js";

  const auth = getAuth();

  const ACTIVE_KEY    = "acsActiveCustomerId";
  const CUSTOMERS_KEY = "acsCustomers"; // only for fallback display; main source is db-customers
  const BILLS_KEY_PREFIX = "acsBills:"; // bills remain local per customer for now

  const acName = document.getElementById("acName");
  const acSub  = document.getElementById("acSub");

  const dateInput  = document.getElementById("date");
  const kgInput    = document.getElementById("kg");
  const rateInput  = document.getElementById("rate");
  const saveBtn    = document.getElementById("saveBtn");
  const statusMsg  = document.getElementById("statusMsg");
  const entriesList= document.getElementById("entriesList");
  const logoutBtn  = document.getElementById("logoutBtn");

  logoutBtn.addEventListener("click", () => window.acsLogout && window.acsLogout());

  function showStatus(text, ok){
    statusMsg.textContent = text || "";
    statusMsg.style.color = ok ? "#047857" : "#b91c1c";
  }

  function todayIso(){
    const t = new Date();
    return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
  }

  function applyDateLimits(){
    const t = todayIso();
    dateInput.max = t; // ‚úÖ future date block (UI)
  }

  function getActiveCustomerId(){
    try { return localStorage.getItem(ACTIVE_KEY) || ""; } catch { return ""; }
  }

  async function getActiveCustomer(){
    const id = getActiveCustomerId();
    if (!id) return null;
    try {
      const customers = await listCustomers();
      return (customers || []).find(c => c.customerId === id) || null;
    } catch {
      // fallback to local (if any)
      try {
        const local = JSON.parse(localStorage.getItem(CUSTOMERS_KEY) || "[]") || [];
        return local.find(c => c.customerId === id) || null;
      } catch {
        return null;
      }
    }
  }

  function getBillsKey(customerId){
    return BILLS_KEY_PREFIX + customerId;
  }

  function getBills(customerId){
    try {
      const raw = localStorage.getItem(getBillsKey(customerId));
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  function statusFromAmounts(bill){
    const total = bill.total || 0;
    const paid  = bill.paid  || 0;
    if (total <= 0) return "pending";
    if (paid <= 0) return "pending";
    if (paid < total) return "loading";
    return "success";
  }

  // Locked only if bill stage is loading/success
  function isLockedDate(customerId, dateIso){
    const bills = getBills(customerId);
    return bills.some(b => {
      if (!b.from || !b.to) return false;
      if (!(b.from <= dateIso && dateIso <= b.to)) return false;
      const s = statusFromAmounts(b);
      return s === "loading" || s === "success";
    });
  }

  // for one date show strongest status (pending/loading/success) if inside any bill
  function statusForDate(customerId, dateIso){
    const bills = getBills(customerId);
    const order = { pending: 1, loading: 2, success: 3 };
    let best = null;

    bills.forEach(b => {
      if (!b.from || !b.to) return;
      if (b.from <= dateIso && dateIso <= b.to) {
        const s = statusFromAmounts(b);
        if (!best || order[s] > order[best]) best = s;
      }
    });

    return best; // null if not in any bill
  }

  function ddmmyyyy(dateIso){
    const [y,m,d] = String(dateIso).split("-");
    return `${d}-${m}-${y}`;
  }

  async function fillInputsIfExists(customerId, dateIso){
    const existing = await getEntry(customerId, dateIso);
    if (existing) {
      kgInput.value = existing.kg ?? "";
      rateInput.value = existing.rate ?? "";
    } else {
      kgInput.value = "";
      rateInput.value = "";
    }
  }

  async function refreshList(customerId){
    entriesList.textContent = "Loading‚Ä¶";
    entriesList.classList.add("muted");

    const rows = await listLatestEntries(customerId, 15);

    if (!rows || rows.length === 0) {
      entriesList.textContent = "No entries yet.";
      entriesList.classList.add("muted");
      return;
    }

    entriesList.innerHTML = "";
    entriesList.classList.remove("muted");

    rows.forEach(r => {
      const dateIso = r.dateIso;
      const total = Number(r.total || (Number(r.kg||0)*Number(r.rate||0)));
      const status = statusForDate(customerId, dateIso);

      const item = document.createElement("div");
      item.className = "entry-item";
      if (status === "pending") item.classList.add("entry-pending");
      if (status === "loading") item.classList.add("entry-loading");
      if (status === "success") item.classList.add("entry-success");

      const left = document.createElement("div");
      left.className = "entry-left";

      const dateSpan = document.createElement("span");
      dateSpan.className = "entry-date";
      dateSpan.textContent = `${dateIso} (${ddmmyyyy(dateIso)})`;
      left.appendChild(dateSpan);

      if (status) {
        const pill = document.createElement("span");
        pill.className = "entry-status-pill " +
          (status === "pending" ? "pill-pending" :
           status === "loading" ? "pill-loading" : "pill-success");
        pill.textContent =
          status === "pending" ? "Pending bill" :
          status === "loading" ? "Bill partial / waiting" :
          "Bill paid";
        left.appendChild(pill);
      }

      const right = document.createElement("div");
      right.className = "entry-right";

      const amountSpan = document.createElement("span");
      amountSpan.style.fontWeight = "1000";
      amountSpan.textContent = `${Number(r.kg||0)} kg √ó ‚Çπ${Number(r.rate||0)} = ‚Çπ${Math.round(total)}`;
      right.appendChild(amountSpan);

      const locked = isLockedDate(customerId, dateIso);

      const editBtn = document.createElement("button");
      editBtn.className = "mini-btn";
      editBtn.textContent = "Edit";
      editBtn.disabled = locked;
      editBtn.title = locked ? "Locked (payment started)" : "";
      editBtn.addEventListener("click", async () => {
        dateInput.value = dateIso;
        await fillInputsIfExists(customerId, dateIso);
        showStatus(locked ? "Locked date (payment started)." : "Edit loaded. Update kg/rate and Save.", !locked);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      const delBtn = document.createElement("button");
      delBtn.className = "mini-btn danger";
      delBtn.textContent = "Delete";
      delBtn.disabled = locked;
      delBtn.title = locked ? "Locked (payment started)" : "";
      delBtn.addEventListener("click", async () => {
        if (locked) return;

        const ok = confirm(`Delete entry for ${dateIso}?`);
        if (!ok) return;

        try {
          await deleteEntry(customerId, dateIso);
          showStatus(`Deleted: ${dateIso}`, true);

          // If deleting currently selected date, clear inputs
          if (dateInput.value === dateIso) {
            kgInput.value = "";
            rateInput.value = "";
          }

          await refreshList(customerId);
        } catch (e) {
          console.error(e);
          showStatus("Delete failed.", false);
        }
      });

      right.appendChild(editBtn);
      right.appendChild(delBtn);

      item.appendChild(left);
      item.appendChild(right);
      entriesList.appendChild(item);
    });
  }

  function setDefaultDate(){
    dateInput.value = todayIso();
  }

  // When date changes, auto-load existing entry (cloud) into inputs (if not locked)
  dateInput.addEventListener("change", async () => {
    const customerId = getActiveCustomerId();
    if (!customerId) return;

    const iso = dateInput.value;
    const t = todayIso();
    if (iso > t) {
      showStatus("Future dates are not allowed.", false);
      dateInput.value = t;
      return;
    }

    const locked = isLockedDate(customerId, iso);
    saveBtn.disabled = locked;
    if (locked) {
      showStatus("This date is locked (payment started).", false);
      kgInput.value = "";
      rateInput.value = "";
      return;
    }

    await fillInputsIfExists(customerId, iso);
    showStatus("", true);
  });

  saveBtn.addEventListener("click", async () => {
    const customerId = getActiveCustomerId();
    if (!customerId) return;

    const dateVal = dateInput.value;
    const t = todayIso();

    if (!dateVal) return showStatus("Please select a date.", false);
    if (dateVal > t) return showStatus("Future dates are not allowed.", false);

    if (isLockedDate(customerId, dateVal)) {
      return showStatus("This date is locked (payment started).", false);
    }

    const kg   = parseFloat(kgInput.value);
    const rate = parseFloat(rateInput.value);

    if (isNaN(kg) || isNaN(rate)) {
      return showStatus("Please enter kg and rate.", false);
    }

    try {
      // ‚úÖ If entry exists, ask overwrite in Gujarati
      const existing = await getEntry(customerId, dateVal);
      if (existing) {
        const ok = confirm(
          `‡™§‡™æ‡™∞‡´Ä‡™ñ ${ddmmyyyy(dateVal)} ‡™®‡´Ä ‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™¶‡™æ‡™ñ‡™≤ ‡™•‡™à ‡™ó‡™Ø‡´á‡™≤ ‡™õ‡´á.\n` +
          `‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á ‡™ú‡´Ç‡™®‡´Ä ‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™®‡™æ ‡™¨‡™¶‡™≤‡´á ‡™®‡™µ‡´Ä ‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™∏‡´á‡™µ ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™Ç‡™ó‡´ã ‡™õ‡´ã?`
        );
        if (!ok) {
          showStatus("Overwrite cancelled.", false);
          return;
        }
      }

      await upsertEntry(customerId, dateVal, { kg, rate });

      showStatus(`Saved: ${dateVal} ‚Üí ${kg} kg √ó ‚Çπ${rate}`, true);

      // ‚úÖ Reset textboxes after save (keep date)
      kgInput.value = "";
      rateInput.value = "";

      await refreshList(customerId);
    } catch (e) {
      console.error(e);
      showStatus(e?.message || "Save failed.", false);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const customerId = getActiveCustomerId();
    if (!customerId) {
      window.location.href = "customers.html";
      return;
    }

    const c = await getActiveCustomer();
    if (c) {
      acName.textContent = c.displayName || "Unnamed customer";
      acSub.textContent  = c.phone ? `üìû ${c.phone}` : "";
    } else {
      acName.textContent = "Unknown customer";
      acSub.textContent = "";
    }

    applyDateLimits();
    setDefaultDate();

    // Load inputs for today (unless locked)
    const locked = isLockedDate(customerId, dateInput.value);
    saveBtn.disabled = locked;
    if (!locked) await fillInputsIfExists(customerId, dateInput.value);

    await refreshList(customerId);
  });
</script>
</body>
</html>
