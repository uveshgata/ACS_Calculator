<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ACS Calculator - REPORT Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared + Page CSS -->
  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="index.css">
</head>
<body>

<div class="wrapper">
  <h1>ACS Calculator</h1>

  <div class="controls">
    <div class="field">
      <label>From date</label>
      <input type="date" id="fromDate">
    </div>

    <div class="field">
      <label>To date</label>
      <input type="date" id="toDate">
    </div>

    <div class="field">
      <label>Default rate (₹ / kg) (optional)</label>
      <input type="number" id="defaultRate" step="0.01" min="0" placeholder="e.g. 230">
    </div>

    <div class="buttons">
      <button class="primary" id="generateRowsBtn">Generate rows</button>
      <button class="secondary" id="downloadImgBtn" disabled>Generate image</button>
      <button class="secondary" onclick="window.location.href='daily-entry.html'">
        Daily entry system
      </button>
      <button class="secondary" onclick="window.location.href='bills.html'">
        Bills / Payments
      </button>
    </div>
  </div>

  <!-- REPORT CARD -->
  <div id="summaryCard">
    <div class="card-header">
      <h2 style="color:#D4AF37">ASHRAFI CHICKEN SHOP</h2>
      <h3>REPORT CARD</h3>
      <div class="range" id="summaryRange"></div>
      <h3 style="float:left">Owner: IQBALHUSHEN GATA</h3>
      <h3 style="float:right">Mobile: 9737248571</h3>
    </div>

    <div class="card-body">
      <table>
        <thead>
          <tr>
            <th>Total (₹)</th>
            <th>Calculation</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="total-label">TOTAL:</td>
            <td class="total-value" id="grandTotalCell">0</td>
          </tr>
          <tr>
            <td colspan="3" class="days-label" id="daysLabel"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="card-footer">
      <div class="footer-line">Generated with ACS_Calculator</div>
      <div class="footer-line">Created By Mohammaduvesh Gata</div>
    </div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ========= STORAGE KEYS ========= */
const ENTRIES_KEY = "acsEntries";
const BILLS_KEY = "acsBills";

/* ========= DOM ========= */
const fromDateInput = document.getElementById("fromDate");
const toDateInput = document.getElementById("toDate");
const defaultRateInput = document.getElementById("defaultRate");
const generateRowsBtn = document.getElementById("generateRowsBtn");
const downloadImgBtn = document.getElementById("downloadImgBtn");
const summaryCard = document.getElementById("summaryCard");
const entriesBody = document.getElementById("entriesBody");
const grandTotalCell = document.getElementById("grandTotalCell");
const summaryRange = document.getElementById("summaryRange");
const daysLabel = document.getElementById("daysLabel");

let lastRangeStart = null;
let lastRangeEnd = null;

/* ========= HELPERS ========= */
function getStoredEntries() {
  try {
    return JSON.parse(localStorage.getItem(ENTRIES_KEY)) || {};
  } catch {
    return {};
  }
}

function getBills() {
  try {
    return JSON.parse(localStorage.getItem(BILLS_KEY)) || [];
  } catch {
    return [];
  }
}

function setBills(bills) {
  localStorage.setItem(BILLS_KEY, JSON.stringify(bills));
}

function formatDateDisplay(d) {
  return d.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
}

function formatDateShort(d) {
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}

function setDaysLabel(start, end) {
  const days = Math.round((end - start) / 86400000) + 1;
  daysLabel.textContent = days > 0 ? `कुल ${days} दिन का हिसाब` : "";
}

/* ========= CREATE ROWS ========= */
function createRows() {
  const fromVal = fromDateInput.value;
  const toVal = toDateInput.value;
  if (!fromVal || !toVal) return alert("Select both dates");

  const start = new Date(fromVal);
  const end = new Date(toVal);
  if (start > end) return alert("Invalid date range");

  lastRangeStart = new Date(start);
  lastRangeEnd = new Date(end);

  const entries = getStoredEntries();
  const defaultRate = parseFloat(defaultRateInput.value);
  const useDefaultRate = !isNaN(defaultRate);

  entriesBody.innerHTML = "";
  let d = new Date(start);

  while (d <= end) {
    const iso = d.toISOString().slice(0,10);
    const saved = entries[iso];

    const tr = document.createElement("tr");
    const totalTd = document.createElement("td");
    const calcTd = document.createElement("td");
    const dateTd = document.createElement("td");

    totalTd.textContent = "0";
    dateTd.textContent = formatDateShort(d);

    const wrap = document.createElement("div");
    wrap.className = "inputs-wrapper";

    const kgInput = document.createElement("input");
    kgInput.placeholder = "kg";

    const rateInput = document.createElement("input");
    rateInput.placeholder = "rate";

    if (saved) {
      kgInput.value = saved.kg;
      rateInput.value = saved.rate;
      totalTd.textContent = (saved.kg * saved.rate).toFixed(0);
    } else if (useDefaultRate) {
      rateInput.value = defaultRate;
    }

    function recalc() {
      const kg = parseFloat(kgInput.value);
      const rate = parseFloat(rateInput.value);
      const total = (!isNaN(kg) && !isNaN(rate)) ? kg * rate : 0;
      totalTd.textContent = total === 0 ? "0" : total.toFixed(0);
      updateGrandTotal();
    }

    kgInput.addEventListener("input", recalc);
    rateInput.addEventListener("input", recalc);

    wrap.append(kgInput, document.createTextNode(" × "), rateInput);
    calcTd.appendChild(wrap);
    tr.append(totalTd, calcTd, dateTd);
    entriesBody.appendChild(tr);

    d.setDate(d.getDate() + 1);
  }

  summaryRange.textContent =
    formatDateDisplay(start) + " to " + formatDateDisplay(end);

  setDaysLabel(start, end);
  summaryCard.style.display = "flex";
  downloadImgBtn.disabled = false;
  updateGrandTotal();
}

function updateGrandTotal() {
  let sum = 0;
  entriesBody.querySelectorAll("tr").forEach(tr => {
    const val = parseFloat(tr.children[0].textContent);
    if (!isNaN(val)) sum += val;
  });
  grandTotalCell.textContent = sum.toLocaleString("en-IN");
}

/* ========= EXPORT ========= */
function syncToDailyEntries() {
  const entries = getStoredEntries();
  entriesBody.querySelectorAll("tr").forEach(tr => {
    const dateText = tr.children[2].textContent;
    const [dd,mm,yyyy] = dateText.split("-");
    const iso = `${yyyy}-${mm}-${dd}`;
    const kg = parseFloat(tr.querySelector("input[placeholder='kg']").value);
    const rate = parseFloat(tr.querySelector("input[placeholder='rate']").value);
    if (!isNaN(kg) && !isNaN(rate)) {
      entries[iso] = { kg, rate };
    }
  });
  localStorage.setItem(ENTRIES_KEY, JSON.stringify(entries));
}

function createBill() {
  const total = parseFloat(grandTotalCell.textContent.replace(/,/g,""));
  if (!total) return;
  const bills = getBills();
  bills.push({
    id: "BILL-" + Date.now(),
    from: fromDateInput.value,
    to: toDateInput.value,
    total,
    paid: 0,
    status: "pending",
    createdAt: new Date().toISOString()
  });
  setBills(bills);
}

async function downloadImage() {
  syncToDailyEntries();
  const canvas = await html2canvas(summaryCard, { scale: 3 });
  const a = document.createElement("a");
  a.download = "report-card.png";
  a.href = canvas.toDataURL();
  a.click();
  createBill();
}

generateRowsBtn.onclick = createRows;
downloadImgBtn.onclick = downloadImage;
</script>

</body>
</html>
